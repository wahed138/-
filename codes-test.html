<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ | Ø´Ø§ØªÙŠ</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ğŸ¨ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
:root {
    --primary: #00F5C4; /* Ø£Ø®Ø¶Ø± Ø³Ø§Ø·Ø¹ */
    --secondary: #FFD700; /* Ø£ØµÙØ± Ø°Ù‡Ø¨ÙŠ */
    --bg-dark: #121212;
    --card-dark: #1e1e1e;
    --text-light: #f5f5f5;
    --error: #FF4F4F;
    --warn: #ffb347;
}

body { 
    font-family: 'Tajawal', sans-serif; /* ÙŠÙØªØ±Ø¶ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø· ØªØ§Ø¬ÙˆØ§Ù„ Ù…Ù† Ù…Ù„ÙØ§ØªÙƒ */
    background: var(--bg-dark); 
    color: var(--text-light); 
    padding: 20px; 
}
h1 { text-align:center; color:var(--primary); margin-bottom: 30px; }
.container-grid {
    display: grid;
    /* 1.5fr (Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙØ¹Ù„Ø©) | 1.5fr (Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø¹Ø·Ù„Ø©) | 300px (Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©) */
    grid-template-columns: 1fr 1fr; /* 2 Ø£Ø¹Ù…Ø¯Ø© Ù…ØªØ³Ø§ÙˆÙŠØ©: Ù…ÙØ¹Ù„ + ØºÙŠØ± Ù…ÙØ¹Ù„ */
    gap: 20px;
    max-width: 1400px;
    margin: 0 auto;
}
.admin-section {
    background: var(--card-dark);
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    overflow-x: auto;
}
.admin-section h2 { 
    color: var(--secondary); 
    margin-bottom: 15px;
    border-bottom: 2px solid rgba(255, 215, 0, 0.2);
    padding-bottom: 10px;
}

/* ğŸ·ï¸ Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
button { 
    padding: 6px 10px; 
    margin: 2px; 
    cursor: pointer; 
    border: none; 
    border-radius: 8px; 
    font-weight: 600;
    transition: 0.3s;
}
.btn-primary { background: var(--primary); color: var(--bg-dark); }
.btn-danger { background: var(--error); color: var(--text-light); }
.btn-warn { background: var(--warn); color: var(--bg-dark); }
.btn-action { background: #3498db; color: var(--text-light); }
.btn-primary:hover, .btn-danger:hover, .btn-warn:hover, .btn-action:hover { opacity: 0.8; transform: translateY(-1px); }

/* ğŸ“Š Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
table { width:100%; border-collapse: collapse; margin-top:15px; font-size: 14px; }
th, td { padding: 10px; text-align: right; border-bottom: 1px solid #333; }
th { background: #333; color: var(--primary); }
tr:hover { background: #2a2a2a; }

/* ğŸ“ Ø³ØªØ§ÙŠÙ„ Ø§Ù„ÙÙˆØ±Ù… ÙˆØ§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
input[type="text"], input[type="number"], select {
    padding: 8px;
    margin: 5px 0;
    border-radius: 6px;
    border: 1px solid #555;
    background: #333;
    color: var(--text-light);
    width: 100%;
}
.form-inline {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 15px;
}
.form-inline > * { flex-grow: 1; }
.form-inline button { flex-grow: 0; }

#statusEl { 
    margin-top: 15px; 
    padding: 10px; 
    border-radius: 8px; 
    background: #2a2a2a; 
    color: var(--primary); 
    text-align: center;
}

/* Ø³ØªØ§ÙŠÙ„Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© */
.general-admin-btns button {
    display: block;
    width: 100%;
    margin: 10px 0;
    padding: 15px;
    font-size: 16px;
}
</style>
</head>
<body>
    <h1>ğŸ”‘ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ ÙˆØ§Ù„Ø£Ù…Ø§Ù†</h1>

    <div id="statusEl">âœ… Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

    <div class="container-grid">
        <div class="admin-section" id="activeCodesSection">
            <h2>Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙØ¹Ù„Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§</h2>
            <input type="text" id="searchActive" 
           placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø¨Ø§Ù„ÙƒÙˆØ¯..." 
           onkeyup="filterCodes()" 
           style="margin-bottom:15px; width: 100%;">
            <div class="form-inline">
                <input type="text" id="newStudentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" required>
                <input type="text" id="addingAdminName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù…ÙØ¶ÙŠÙ" value="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" required> <input type="number" id="newDuration" placeholder="Ø§Ù„Ù…Ø¯Ø© (ÙŠÙˆÙ…)" min="1" max="300" value="30" required>
                <button class="btn-primary" onclick="addNewCode()">â• Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</button>
                <button class="btn-warn" onclick="addNewCode(true)">â±ï¸ ÙƒÙˆØ¯ ØªØ¬Ø±Ø¨Ø© (Ø³Ø§Ø¹Ø©)</button>
            </div>

            <table>
                <thead>
                    <tr>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„</th>
                    <th>Ø¬Ù‡Ø§Ø² Ø§Ù„Ø·Ø§Ù„Ø¨ (Device ID)</th>
                    <th>Ø§Ù„Ù…Ø¯Ø© (ÙŠÙˆÙ…)</th>       <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙØ¹ÙŠÙ„</th>   <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                    <th>Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù…ÙØ¶ÙŠÙ</th>   <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="activeCodesBody">
                <tr><td colspan='8'>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯...</td></tr> 
            </tbody>
        </table>
        </div>

        <div class="admin-section" id="deactivatedCodesSection">
            <h2>Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ØºÙŠØ± Ø§Ù„Ù…ÙØ¹Ù„Ø© / Ø§Ù„Ù…Ø¹Ø·Ù„Ø©</h2>
            <input type="text" id="searchDeactivated" 
           placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø¨Ø§Ù„ÙƒÙˆØ¯..." 
           onkeyup="filterCodes()" 
           style="margin-bottom:15px; width: 100%;">
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù†ØªÙ‡Ù‰ Ø¨ØªØ§Ø±ÙŠØ®</th>     <th>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¯Ø© (ÙŠÙˆÙ…)</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                </thead>
                <tbody id="deactivatedCodesBody">
                    <tr><td colspan='6'>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯...</td></tr> 
                </tbody>
            </table>
        </div>
    </div>
    

    <script>
        // ğŸš¨ Configuration - Ù„Ø§Ø²Ù… ØªØ­Ø· Ø§Ù„Ù€ Configuration Ø¨ØªØ§Ø¹Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§
        const firebaseConfig = {
          apiKey: "AIzaSyBK6FZF3LW83qaUHBKYTfiVd2Ozrd1Rf2g",
          authDomain: "thanawy-1383.firebaseapp.com",
          databaseURL: "https://thanawy-1383-default-rtdb.firebaseio.com",
          projectId: "thanawy-1383",
          storageBucket: "thanawy-1383.firebasestorage.app",
          messagingSenderId: "1026664406457",
          appId: "1:1026664406457:web:87d71f7e41bef36ba0aa68",
          measurementId: "G-J5R2EFM2D0"
        };
        
        if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        const statusEl = document.getElementById('statusEl');
        const activeCodesBody = document.getElementById('activeCodesBody');
        const deactivatedCodesBody = document.getElementById('deactivatedCodesBody');

        // **********************************************
        // ğŸš¨ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙØ±ÙŠØ¯ (6 Ø£Ø±Ù‚Ø§Ù…)
        // **********************************************

        function generateRandom6DigitUID() {
            const min = 100000;
            const max = 999999;
            return Math.floor(Math.random() * (max - min + 1) + min).toString();
        }

        
        async function isUIDUsed(uid) {
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ù… (approvedStudents) ğŸ†• ØªØ£ÙƒØ¯ÙŠ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
                const approvedSnap = await db.ref('approvedStudents/' + uid).once('value'); 
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚ÙŠÙ† (pendingStudents) - Ø§Ø­ØªÙŠØ§Ø·ÙŠÙ‹Ø§
                const pendingSnap = await db.ref('pendingStudents/' + uid).once('value');
                
                return approvedSnap.exists() || pendingSnap.exists(); // ğŸ†• Ø§Ø³ØªØ®Ø¯Ø§Ù… approvedSnap
            } catch (error) {
                console.error("Firebase Check Error:", error);
                showToast("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯.", "error");
                // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù†Ø¹ØªØ¨Ø±Ù‡ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠ
                return false; 
            }
        }
        
        async function getUniqueActivationCode() {
            let uid;
            let isUsed = true;
            let attempts = 0;
            const maxAttempts = 50; 
            
            statusEl.textContent = 'â³ Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ ØªÙØ¹ÙŠÙ„ ÙØ±ÙŠØ¯...';

            while (isUsed && attempts < maxAttempts) {
                uid = generateRandom6DigitUID();
                isUsed = await isUIDUsed(uid); 
                attempts++;
            }
            
            if(attempts >= maxAttempts && isUsed) {
                throw new Error("âŒ ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ ÙØ±ÙŠØ¯ Ø¨Ø¹Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¹Ø¯ÙŠØ¯Ø©.");
            }
            return uid;
        }

        // **********************************************
        // ğŸš¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙØ¹Ù„Ø© (Active Codes)
        // **********************************************
        // ğŸš¨ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø§Ø±Ø§Ù…ØªØ± isTrial = false
        async function addNewCode(isTrial = false) { 
            const name = document.getElementById('newStudentName').value.trim();
    
    // ğŸ†• Ù„Ùˆ isTrial Ø¨Ù€ (true)ØŒ Ø§Ù„Ù…Ø¯Ø© Ù‡ØªÙƒÙˆÙ† (1/24) ÙŠÙˆÙ… = Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©
            const durationDays = isTrial ? (1 / 24) : parseInt(document.getElementById('newDuration').value);
    
    // ğŸš¨ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù€Validation Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ¬Ø±Ø¨Ø© Ø£Ùˆ ÙƒÙˆØ¯ Ø¹Ø§Ø¯ÙŠ
            if (!name) {
                showToast("âŒ Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨.", "error");
                return;
            }
            if (!isTrial && (durationDays < 1 || durationDays > 300)) {
                showToast("âŒ Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¯Ø© Ø¨ÙŠÙ† 1 Ùˆ 300 ÙŠÙˆÙ… Ù„ÙƒÙˆØ¯ Ø¹Ø§Ø¯ÙŠ.", "error");
                return;
            }

            const adminName = document.getElementById('addingAdminName').value.trim() || "Admin_Chati";
    
            try {
                const newCode = await getUniqueActivationCode();
        
                const approvedAt = Date.now();
        // Ø§Ù„Ø­Ø³Ø¨Ø© Ø¯ÙŠ Ù‡ØªØ´ØªØºÙ„ ØµØ­ Ø³ÙˆØ§Ø¡ durationDays ÙƒØ§Ù†Øª Ø±Ù‚Ù… ØµØ­ÙŠØ­ (Ø£ÙŠØ§Ù…) Ø£Ùˆ ÙƒØ³Ø± (Ø³Ø§Ø¹Ø©)
                const expiry = approvedAt + (durationDays * 24 * 60 * 60 * 1000); 

                await db.ref('approvedStudents/' + newCode).set({
                    name: name,
                    admin: adminName,
                    approvedAt: approvedAt, 
                    expiry: expiry,
                    deviceId: "", 
                    isBlocked: false,
                    isExpired: false,
                    deactivatedOn: null,
                    isTrial: isTrial // ğŸ†• Ù‡Ù†Ø¶ÙŠÙ Ù…Ø¤Ø´Ø± Ø¥Ù† Ø¯Ù‡ ÙƒÙˆØ¯ ØªØ¬Ø±Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ù„ÙƒÙ† Ù…ÙÙŠØ¯)
                });

                const msg = isTrial ? 
                    `âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ ØªØ¬Ø±Ø¨Ø© (Ø³Ø§Ø¹Ø©) Ø¬Ø¯ÙŠØ¯: ${newCode} Ù„Ù„Ø·Ø§Ù„Ø¨: ${name}` :
                    `âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯: ${newCode} Ù„Ù„Ø·Ø§Ù„Ø¨: ${name}`;

                showToast(msg, "success");
                document.getElementById('newStudentName').value = '';
                if(!isTrial) document.getElementById('newDuration').value = 30; // Ù„Ùˆ Ù…Ø´ ØªØ¬Ø±Ø¨Ø©ØŒ Ù†Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                loadCodes(); 
            } catch (error) {
                showToast("âŒ Ø®Ø·Ø£: " + error.message, "error");
                console.error(error);
            }
        }
        
        // **********************************************
        // ğŸš¨ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
        // **********************************************

        // 1. ØªØ¹Ø·ÙŠÙ„ (Block)
        function blockCode(uid, name) {
            if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø·ÙŠÙ„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ${name} (${uid})ØŸ`)){
                db.ref('approvedStudents/' + uid).update({
                    isBlocked: true,
                    deviceId: "" // ğŸš¨ Ù…Ù‡Ù…: Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù€ Device ID Ù„ÙŠØªÙØ¹Ù„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø± Ù„Ùˆ ØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§
                }).then(() => {
                    showToast(`ğŸ›‘ ØªÙ… ØªØ¹Ø·ÙŠÙ„ ÙƒÙˆØ¯ ${uid}.`, "warn");
                    loadCodes();
                }).catch(e => showToast("âŒ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø·ÙŠÙ„: " + e.message, "error"));
            }
        }

        // 2. Ø­Ø°Ù (Delete)
        function deleteCode(uid, name, listName) {
            if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ${name} (${uid}) Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© ${listName}ØŸ`)){
                db.ref('approvedStudents/' + uid).remove().then(() => {
                    showToast(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ ${uid} Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§.`, "error");
                    loadCodes();
                }).catch(e => showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + e.message, "error"));
            }
        }

        // 3. ØªØ¬Ø¯ÙŠØ¯/ØªÙØ¹ÙŠÙ„ (Renew/Activate)
        function renewCode(uid, name, durationInputId) {
            const durationDays = parseInt(document.getElementById(durationInputId).value);

            if (durationDays < 1 || durationDays > 300) {
                showToast("âŒ Ø§Ù„Ù…Ø¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 1 Ùˆ 300 ÙŠÙˆÙ….", "error");
                return;
            }
            
            if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ${name} (${uid}) Ù„Ù…Ø¯Ø© ${durationDays} ÙŠÙˆÙ…ØŸ`)){
                const approvedAt = Date.now();
                const expiry = approvedAt + (durationDays * 24 * 60 * 60 * 1000); // Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø£Ù„Ù Ù…Ù† Ø§Ù„Ø«Ø§Ù†ÙŠØ©

                db.ref('approvedStudents/' + uid).update({
                    expiry: expiry,
                    isBlocked: false,
                    isExpired: false,
                    deviceId: "" // ğŸš¨ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù€ Device ID Ù„ØªØ³Ø¬ÙŠÙ„ Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯
                }).then(() => {
                    showToast(`âœ… ØªÙ… ØªÙØ¹ÙŠÙ„/ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ ${uid} Ù„Ù€ ${durationDays} ÙŠÙˆÙ….`, "success");
                    loadCodes();
                }).catch(e => showToast("âŒ ÙØ´Ù„ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯: " + e.message, "error"));
            }
        }


        // **********************************************
        // ğŸš¨ ÙˆØ¸ÙŠÙØ© ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
        // **********************************************
        // **********************************************
        // ğŸš¨ ÙˆØ¸ÙŠÙØ© ÙÙ„ØªØ±Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«
// **********************************************
        function filterCodes() {
    // 1. Ù‚Ø±Ø§Ø¡Ø© Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨Ø­Ø« Ù…Ù† Ø§Ù„Ø®Ø§Ù†ØªÙŠÙ†
            const searchActive = document.getElementById('searchActive').value.toLowerCase();
            const searchDeactivated = document.getElementById('searchDeactivated').value.toLowerCase();

    // 2. ÙÙ„ØªØ±Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù†Ø´Ø·Ø©
            const activeRows = activeCodesBody.getElementsByTagName('tr');
            for (let i = 0; i < activeRows.length; i++) {
        // Ø§Ù„Ù€textContent Ø¨ÙŠØ¬ÙŠØ¨ ÙƒÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ù„ÙŠ ÙÙŠ Ø§Ù„Ù€Row (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„ÙƒÙˆØ¯ØŒ Ø§Ù„Ø­Ø§Ù„Ø©... Ø¥Ù„Ø®)
                const rowText = activeRows[i].textContent.toLowerCase(); 
        
        // Ø§Ø³ØªØ«Ù†Ø§Ø¡ ØµÙÙˆÙ "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„" Ø£Ùˆ "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯"
                if (rowText.includes('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„') || rowText.includes('Ù„Ø§ ÙŠÙˆØ¬Ø¯')) continue; 

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙ Ù„Ùˆ Ø§Ù„Ù†Øµ Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡ Ø¨ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø«
                if (rowText.includes(searchActive)) {
                    activeRows[i].style.display = ""; 
                } else {
                    activeRows[i].style.display = "none";
                }
            }

    // 3. ÙÙ„ØªØ±Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø¹Ø·Ù„Ø©
            const deactivatedRows = deactivatedCodesBody.getElementsByTagName('tr');
            for (let i = 0; i < deactivatedRows.length; i++) {
                const rowText = deactivatedRows[i].textContent.toLowerCase();
        
                if (rowText.includes('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„') || rowText.includes('Ù„Ø§ ÙŠÙˆØ¬Ø¯')) continue;
        
                if (rowText.includes(searchDeactivated)) {
                    deactivatedRows[i].style.display = ""; 
                } else {
                    deactivatedRows[i].style.display = "none"; 
                }
            }
        }

        function loadCodes() {
            activeCodesBody.innerHTML = `<tr><td colspan='5'>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙØ¹Ù„Ø©...</td></tr>`;
            deactivatedCodesBody.innerHTML = `<tr><td colspan='5'>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ØºÙŠØ± Ø§Ù„Ù…ÙØ¹Ù„Ø©...</td></tr>`;

            const activeRows = [];
            const deactivatedRows = [];
            
            const now = Date.now();

            db.ref("approvedStudents").once("value")
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        activeCodesBody.innerHTML = `<tr><td colspan='5'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ù…ÙØ¹Ù„Ø©.</td></tr>`;
                        deactivatedCodesBody.innerHTML = `<tr><td colspan='5'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ ØºÙŠØ± Ù…ÙØ¹Ù„Ø©.</td></tr>`;
                        return;
                    }

                    snapshot.forEach(child => {
                        const uid = child.key;
                        const data = child.val();
                        let statusText = '';
                        let rowContent = '';
                        
                       // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙˆØ¯
                        const isExpired = data.expiry && data.expiry <= now;
                        const isBlocked = data.isBlocked === true;

                        // ğŸš¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙˆØ§Ù„ÙƒÙˆØ¯ Ù„Ø³Ø© Ù…Ø´ Ù…ØªØ¹Ø·Ù„ (isBlocked: false)
                        if (isExpired && !isBlocked) {
                            // ğŸ†• ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Firebase Ù„ÙŠØªØ¹Ø·Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§
                            db.ref('approvedStudents/' + uid).update({
                                isExpired: true, // Ù…Ø¤Ø´Ø± Ø¥Ø¶Ø§ÙÙŠ
                                isBlocked: true, // ØªØ¹Ø·ÙŠÙ„ ÙØ¹Ù„ÙŠ Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø·Ù„Ø©
                                deviceId: "",
                                deactivatedOn: now // ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹Ø·ÙŠÙ„
                            });
                            // Ù†Ø±Ø¬Ø¹ Ù„Ù„Ù€loop Ø¹Ø´Ø§Ù† ÙŠØ­Ù…Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø¬Ø§ÙŠØ© Ø£Ùˆ Ù†Ø¹ØªØ¨Ø±Ù‡ Ù…Ø¹Ø·Ù„ Ø¯Ù„ÙˆÙ‚ØªÙŠ
                            data.isExpired = true;
                            data.isBlocked = true;
                        }

                        let expiryDate = data.expiry ? new Date(data.expiry).toLocaleDateString("ar-EG") : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                        
                        if (!data.isExpired && !data.isBlocked) { // ÙƒÙˆØ¯ Ù…ÙØ¹Ù„
// ... ÙˆÙ‡Ù†Ø§ Ø¨ÙŠÙƒÙ…Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¨ØªØ§Ø¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙØ¹Ù„Ø©
                            
                            const deviceStatus = data.deviceId ? `Ù…ÙØ³Ø¬Ù„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²: ${data.deviceId.substring(0, 10)}...` : 'âš ï¸ ØºÙŠØ± Ù…ÙØ³Ø¬Ù„ Ø¹Ù„Ù‰ Ø£ÙŠ Ø¬Ù‡Ø§Ø²';
// ... Ø¬ÙˆÙ‡ if (!data.isExpired && !data.isBlocked) { ...
// ğŸ†• ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                            const approvedDate = data.approvedAt ? new Date(data.approvedAt).toLocaleDateString("ar-EG") : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                            const durationDays = data.expiry ? Math.ceil((data.expiry - data.approvedAt) / (24 * 60 * 60 * 1000)) : '-';

                            rowContent = `
                                <td>${data.name || "-"}</td>
                                <td style="color:var(--primary); font-weight:700;">${uid}</td>
                                <td>${deviceStatus}</td>
                                <td>${durationDays} ÙŠÙˆÙ…</td> <td>${approvedDate}</td> <td>${expiryDate}</td>
                                <td>${data.admin || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}</td> <td>
                                    <input type="number" id="renew_active_${uid}" min="1" max="300" value="30" style="width:70px; display:inline;" />
                                    <button class="btn-primary" onclick="renewCode('${uid}','${data.name}','renew_active_${uid}')">ğŸ”„ ØªØ¬Ø¯ÙŠØ¯</button>
                                    <button class="btn-warn" onclick="blockCode('${uid}','${data.name}')">ğŸš« ØªØ¹Ø·ÙŠÙ„</button>
                                    <button class="btn-danger" onclick="deleteCode('${uid}','${data.name}', 'Ø§Ù„Ù…ÙØ¹Ù„Ø©')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                                </td>
                            `;
                            activeRows.push(`<tr>${rowContent}</tr>`);
// ...
                        } else {
                            // ğŸ”´ ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙØ¹Ù„ (Deactivated/Expired)
                            // ... Ø¬ÙˆÙ‡ } else { ...

                            // ğŸ†• ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù€Logic Ø¨ØªØ§Ø¹ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø©
                            let deactivatedDate = data.deactivatedOn ? new Date(data.deactivatedOn).toLocaleDateString("ar-EG") : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

                            if (isBlocked && !data.isExpired) statusText = 'Ù…ÙØ¹Ø·Ù‘Ù„ ÙŠØ¯ÙˆÙŠÙ‹Ø§';
                            else if (isExpired && data.deactivatedOn) statusText = 'Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§'; // ğŸ†• Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
                            else if (isExpired) statusText = 'Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØªÙ‡';
                            else statusText = 'ØºÙŠØ± Ù†Ø´Ø·';

                            rowContent = `
                                <td>${data.name || "-"}</td>
                                <td style="color:var(--error); font-weight:700;">${uid}</td>
                                <td><span style="color:${isBlocked ? 'var(--warn)' : 'var(--error)'};">${statusText}</span></td>
                                <td>${deactivatedDate}</td> <td>
                                    <input type="number" id="renew_deactive_${uid}" min="1" max="300" value="30" style="width:70px; display:inline;" />
                                </td>
                                <td>
                                    <button class="btn-primary" onclick="renewCode('${uid}','${data.name}','renew_deactive_${uid}')">âœ… ØªÙØ¹ÙŠÙ„/ØªØ¬Ø¯ÙŠØ¯</button>
                                    <button class="btn-danger" onclick="deleteCode('${uid}','${data.name}', 'ØºÙŠØ± Ø§Ù„Ù…ÙØ¹Ù„Ø©')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                                </td>
                            `;
                            deactivatedRows.push(`<tr>${rowContent}</tr>`);
// ...
                        }
                    });

                    activeCodesBody.innerHTML = activeRows.join('') || `<tr><td colspan='5'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ù…ÙØ¹Ù„Ø©.</td></tr>`;
                    deactivatedCodesBody.innerHTML = deactivatedRows.join('') || `<tr><td colspan='5'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ ØºÙŠØ± Ù…ÙØ¹Ù„Ø©.</td></tr>`;
                    statusEl.textContent = `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${activeRows.length} ÙƒÙˆØ¯ Ù…ÙØ¹Ù„ Ùˆ ${deactivatedRows.length} ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙØ¹Ù„.`;
                    
// ğŸš¨ ğŸ†• Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù„ÙŠ Ù„Ø§Ø²Ù… ÙŠØªØ¶Ø§Ù Ù‡Ù†Ø§:
                    filterCodes();
                })
                .catch(err => {
                    statusEl.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + err.message;
                    activeCodesBody.innerHTML = `<tr><td colspan='5'>âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>`;
                    deactivatedCodesBody.innerHTML = `<tr><td colspan='5'>âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>`;
                    console.error(err);
                });
        }
        
        // ğŸ“Š Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Chart Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ù…Ø§Ù†
        let securityChart;
        function updateSecurityChart(activeCount, deactivatedCount) {
            const ctx = document.getElementById("securityChart").getContext("2d");
            if (securityChart) securityChart.destroy();

            securityChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ø£ÙƒÙˆØ§Ø¯ Ù†Ø´Ø·Ø©', 'Ø£ÙƒÙˆØ§Ø¯ Ù…Ø¹Ø·Ù„Ø©/Ù…Ù†ØªÙ‡ÙŠØ©'],
                    datasets: [{
                        data: [activeCount, deactivatedCount],
                        backgroundColor: [varToString('--primary'), varToString('--error')],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: varToString('--text-light') } },
                        title: {
                            display: true,
                            text: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯',
                            color: varToString('--secondary')
                        }
                    }
                }
            });
        }

        function varToString(cssVar) {
             const rootStyle = getComputedStyle(document.documentElement);
             return rootStyle.getPropertyValue(cssVar).trim();
        }

        // âœ… Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙˆØ³Øª
        function showToast(message, type = "info") {
            // ØªÙ†ÙÙŠØ° Ø¯Ø§Ù„Ø© showToast Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù‡Ù†Ø§
            const toast = document.createElement("div");
            toast.textContent = message;
            toast.style.position = "fixed";
            toast.style.bottom = "20px";
            toast.style.right = "20px";
            toast.style.padding = "10px 20px";
            toast.style.borderRadius = "12px";
            toast.style.zIndex = "9999";
            toast.style.background = type === "error" ? "var(--error)" : type === "success" ? "var(--primary)" : "var(--warn)";
            toast.style.color = type === "success" ? "var(--bg-dark)" : "var(--text-light)";
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        
        
        // ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        loadCodes();
    </script>
</body>
</html>
