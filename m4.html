<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ø§Ù„Ù…Ø´ØªØ±ÙƒÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙˆÙ†</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
    // ğŸš¨ Ù„Ø§Ø²Ù… ØªØ­Ø· Ø§Ù„Ù€ Configuration Ø¨ØªØ§Ø¹Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§ ÙŠØ§ Ø³Ùˆ
    const firebaseConfig = {
        apiKey: "AIzaSyBK6FZF3LW83qaUHBKYTfiVd2Ozrd1Rf2g",
        authDomain: "thanawy-1383.firebaseapp.com",
        databaseURL: "https://thanawy-1383-default-rtdb.firebaseio.com",
        projectId: "thanawy-1383",
        storageBucket: "thanawy-1383.firebasestorage.app",
        messagingSenderId: "1026664406457",
        appId: "1:1026664406457:web:87d71f7e41bef36ba0aa68",
        measurementId: "G-J5R2EFM2D0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
</script>

<style>
body { font-family:sans-serif; background:#111; color:white; padding:20px; }
h1 { text-align:center; color:#00f5c4; }
button { padding:8px 15px; margin:3px; cursor:pointer; border:none; border-radius:5px; font-weight:bold; }
.disable { background:#ffb347; color:black; }
.reactivate { background:#00c896; color:white; }
.delete { background:#ff4f4f; color:white; }
table { width:100%; border-collapse: collapse; margin-top:20px; background:#222; }
th, td { padding:12px; border:1px solid #333; text-align:right; }
th { background:#333; color:#00f5c4; }
.status-msg { background:rgba(0,245,196,0.2); color:#00f5c4; padding:10px; border-radius:8px; margin-top:15px; }
.active-status { color: #00c896; font-weight: bold; }
.disabled-status { color: #ffb347; font-weight: bold; }
.expired-status { color: #ff4f4f; font-weight: bold; }
</style>
</head>
<body>
  <h1>âœ… Ø§Ù„Ù…Ø´ØªØ±ÙƒÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙˆÙ†</h1>

  <div class="status-msg" id="statusEl" style="display: none;"></div>

  <table id="studentsTable">
    <thead>
      <tr>
        <th>ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„</th> 
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th>Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (Ù†Ø´Ø·/Ù…Ø³Ù…ÙˆØ­)</th>
        <th>Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
      </tr>
    </thead>
    <tbody id="studentsBody">
      <tr><td colspan="6">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†...</td></tr>
    </tbody>
  </table>

  <script>
    const studentsBody = document.getElementById("studentsBody");
    const statusEl = document.getElementById("statusEl");

    // =======================================================
    // ğŸ’¡ Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
    // =======================================================
    function getRemainingTime(expiry) {
        const now = Date.now();
        const distance = expiry - now;

        if (distance <= 0) return { days: 0, hours: 0, minutes: 0, expired: true };

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

        return { days, hours, minutes, expired: false };
    }

    // =======================================================
    // ğŸ’¡ Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ù…
    // =======================================================
    function loadStudents(){
      statusEl.style.display = "none";
      studentsBody.innerHTML="<tr><td colspan='6'>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†...</td></tr>";
      
      db.ref("approvedStudents").once("value")
        .then(snapshot=>{
          if(!snapshot.exists()){
            studentsBody.innerHTML="<tr><td colspan='6'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙƒÙˆÙ† Ø­Ø§Ù„ÙŠÙ‹Ø§.</td></tr>";
            return;
          }
          
          studentsBody.innerHTML = "";
          snapshot.forEach(child=>{
            const activationCode = child.key; 
            const data = child.val();
            const time = getRemainingTime(data.expiry);
            
            const activeDevices = Object.keys(data.currentDevices || {}).length;
            const maxDevices = data.maxDevices || 1; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¬Ù‡Ø§Ø² ÙˆØ§Ø­Ø¯

            let statusText = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            let statusClass = 'disabled-status';
            
            if (time.expired) {
                statusText = 'âŒ Ù…Ù†ØªÙ‡ÙŠ';
                statusClass = 'expired-status';
            } else if (data.status === 'active') {
                statusText = 'âœ… Ù†Ø´Ø·';
                statusClass = 'active-status';
            } else if (data.status === 'disabled') {
                statusText = 'âš ï¸ Ù…Ø¹Ø·Ù„';
                statusClass = 'disabled-status';
            }
            
            const remainingTimeText = time.expired 
                ? '0 ÙŠÙˆÙ…' 
                : `${time.days} ÙŠÙˆÙ… Ùˆ ${time.hours} Ø³`;
                
            // Ø²Ø± Ø§Ù„ØªØ¹Ø·ÙŠÙ„ / Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„
            const actionButton = data.status === 'active' && !time.expired
                ? `<button class="disable" onclick="toggleActivation('${activationCode}', 'disabled', '${data.name}')">ØªØ¹Ø·ÙŠÙ„</button>`
                : `<button class="reactivate" onclick="toggleActivation('${activationCode}', 'active', '${data.name}')">Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„</button>`;
            
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td><strong>${activationCode}</strong></td>
              <td>${data.name || "-"}</td>
              <td>${activeDevices} / ${maxDevices}</td>
              <td>${remainingTimeText}</td>
              <td><span class="${statusClass}">${statusText}</span></td>
              <td>
                ${actionButton}
                <button class="delete" onclick="deleteStudent('${activationCode}','${data.name || ''}')">Ø­Ø°Ù</button>
              </td>
            `;
            studentsBody.appendChild(tr);
          });
        });
    }

    // =======================================================
    // ğŸ’¡ Ø¯Ø§Ù„Ø© ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
    // =======================================================
    async function toggleActivation(activationCode, newStatus, name) {
        const action = newStatus === 'active' ? 'Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„' : 'ØªØ¹Ø·ÙŠÙ„';
        if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ${action} Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø·Ø§Ù„Ø¨: ${name}ØŸ`)) return;

        try {
            await db.ref(`approvedStudents/${activationCode}/status`).set(newStatus);
            statusEl.textContent = `âœ… ØªÙ… ${action} ${name} Ø¨Ù†Ø¬Ø§Ø­.`;
            statusEl.style.display = "block";
            loadStudents();
        } catch (err) {
            alert(`âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ${action}: ${err.message}`);
            console.error(err);
        }
    }


    // =======================================================
    // ğŸ’¡ Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨
    // =======================================================
    function deleteStudent(activationCode,name){
      if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„: ${activationCode} Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ ${name || 'Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨'}ØŸ`)){
        db.ref("approvedStudents/"+activationCode).remove()
          .then(()=>{
            statusEl.textContent=`âœ… ØªÙ… Ø­Ø°Ù ÙƒÙˆØ¯ ${activationCode} Ø¨Ù†Ø¬Ø§Ø­.`;
            statusEl.style.display = "block";
            loadStudents();
          })
          .catch(err=>{
            alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: " + err.message);
            console.error(err);
          });
      }
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    loadStudents();

    function downloadM4() {
        const code = document.documentElement.outerHTML.replace(/<button onclick="downloadM4\(\)">ØªØ­Ù…ÙŠÙ„ ÙƒÙˆØ¯ m4\.html Ø§Ù„Ù…ÙØ¹Ø¯Ù‘ÙÙ„ ÙƒØ§Ù…Ù„Ø§Ù‹<\/button>/g, '');
        const blob = new Blob([code], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'm4.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
